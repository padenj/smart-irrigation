name: Build and Release with Semantic Versioning

on:
  push:
    branches:
      - main # Trigger workflow only on pushes to the main branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20 # Change to your Node.js version

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Update semantic version
      id: versioning
      run: |
        echo "Determining semantic version..."
        CURRENT_VERSION=$(git describe --tags --abbrev=0)
        NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. -v OFS=. '{$NF++; print}')
        echo $NEW_VERSION > version.txt
        echo "::set-output name=new_version::$NEW_VERSION"

    - name: Tag new semantic version
      run: |
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"
        git tag ${{ steps.versioning.outputs.new_version }}
        git push origin ${{ steps.versioning.outputs.new_version }}

    - name: Include version in build
      run: cp version.txt ./build/

    - name: Create release package
      run: zip -r release-package.zip . -x '*.git*' 'node_modules/*'

    - name: Upload to GitHub Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: release-package.zip
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ steps.versioning.outputs.new_version }}
        name: Release ${{ steps.versioning.outputs.new_version }}
